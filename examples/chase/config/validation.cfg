!title pigean validation pipeline

lap_home=/humgen/diabetes2/users/chase/lap

#run with
#perl $lap_home/trunk/bin/run.pl --meta /path/to/meta/file
#web UI at
#https://intranet.broadinstitute.org/~flannick/lap/
#type in full path of meta file
#=======================================================================================================================
#CLASSES
#These are the levels at which files will be created and commands will be run
#You load instances for each class in the companion meta file
#A file assigned to the class will be created for each instance in the class
#A command assisnged to the class will run once per instance
#Classes are a tree structure, so ancestors have parents and descendents
#Each instance has properties, which by default are its instance name, ancestor instance names, and descendent instance names (accessible via @'class')
class project=Project
# Validation Project
class validation=Validation parent project
class trait_group=Trait Group parent validation
class trait=Trait parent trait_group
class model=Model parent validation
class genesets=Genesets Lists parent validation
class results=Results parent validation
class experiment=Experiment parent trait_group
class p_experiment=P-Experiment parent trait_group
class run=Run parent experiment
class mask=Mask parent run

#=======================================================================================================================
#DIRECTORIES
#path prefix means this is a UNIX path
sortable mkdir path projects_dir=$unix_out_dir/projects/validation
sortable mkdir path project_dir=$projects_dir/@project class_level project
sortable mkdir path validation_dir=$project_dir/@validation class_level validation
sortable mkdir path trait_group_dir=$validation_dir/trait_groups/@trait_group class_level trait_group
sortable mkdir path results_dir=$validation_dir/results class_level results
sortable mkdir path trait_dir=$trait_group_dir/@trait class_level trait
sortable mkdir path model_dir=$validation_dir/models/@model class_level model
sortable mkdir path genesets_dir=$validation_dir/genesets/@genesets class_level genesets
sortable mkdir path experiment_dir=$trait_group_dir/experiments/@experiment class_level experiment
sortable mkdir path p_experiment_dir=$trait_group_dir/p_experiments/@p_experiment class_level p_experiment
sortable mkdir path run_dir=$experiment_dir/runs/@run class_level run
sortable mkdir path mask_dir=$run_dir/masks/@mask class_level mask
#=======================================================================================================================
#CATEGORIES
cat project_cat=null disp "Project files" class_level project
cat validation_cat=null disp "Validation files" class_level validation
cat trait_group_cat=null disp "Trait Group files" class_level trait_group
cat results_cat=null disp "Results files" class_level results
cat trait_cat=null disp "Trait files" class_level trait
cat model_cat=null disp "Model files" class_level model
cat genesets_cat=null disp "Genesets files" class_level genesets
cat experiment_cat=null disp "Experiment files" class_level experiment
cat p_experiment_cat=null disp "P-Experiment files" class_level p_experiment
cat run_cat=null disp "Run files" class_level run
cat mask_cat=null disp "Masking Run files" class_level mask
#=======================================================================================================================
#FILES

# PROJECT LEVEL ==============================

# VALIDATION PROJECT LEVEL ==============================
path file models_config_file=@validation.models_config_file.yaml dir project_dir disp "Model Configurations" parent validation_cat class_level validation
path file gold_standard_genes_file=@validation.gold_standard_genes.portal.json dir project_dir disp "Gold Standard Genes" parent validation_cat class_level validation
table path file phenotype_file=@validation.phenotypes.tsv dir project_dir disp "Phenotypes" parent validation_cat class_level validation
table path file phenotype_info_file=@validation.phenotype_info.csv dir project_dir disp "Phenotype Info" parent validation_cat class_level validation
table path file phenotype_sample_size_file=@validation.phenotype_sample_size.tsv dir project_dir disp "Phenotype Sample Size" parent validation_cat class_level validation
path file model_selection_plot_out_file=@validation.model_selection_plot.html dir project_dir disp "Model Selection Plot" parent validation_cat class_level validation
table path file model_selection_trait_metrics_out_file=@validation.model_selection_trait_metrics.tsv dir project_dir disp "Model Selection Trait Metrics" parent validation_cat class_level validation
table path file model_selection_collapsed_metrics_out_file=@validation.model_selection_collapsed_metrics.tsv dir project_dir disp "Model Selection Collapsed Metrics" parent validation_cat class_level validation
path file model_selection_log_file=@validation.model_selection.log dir project_dir disp "Model Selection Log" parent validation_cat class_level validation
table path file geneset_list_stats_file=@validation.geneset_list_stats.tsv dir project_dir disp "Geneset List Stats" parent validation_cat class_level validation
path file geneset_list_stats_plot_file=@validation.geneset_list_stats.pdf dir project_dir disp "Geneset List Stats Plot" parent validation_cat class_level validation
table path file geneset_libraries_stats_file=@validation.geneset_libraries_stats.tsv dir project_dir disp "Geneset Libraries Stats" parent validation_cat class_level validation
path file geneset_libraries_plot_file=@validation.geneset_libraries_plot.html dir project_dir disp "Geneset Libraries Plot" parent validation_cat class_level validation
path file cross_phenotype_embeddings_file=@validation.cross_phenotype_embeddings.npz dir project_dir disp "Cross Phenotype Embeddings" parent validation_cat class_level validation
table path file cross_phenotype_similarity_matrix_file=@validation.cross_phenotype_similarity_matrix.tsv dir project_dir disp "Cross Phenotype Similarity Matrix" parent validation_cat class_level validation
path file cross_phenotype_cluster_visualization_file=@validation.cross_phenotype_cluster_visualization.html dir project_dir disp "Cross Phenotype Cluster Visualization" parent validation_cat class_level validation

# RESULTS LEVEL ==============================
results_trunk=@results dir results_dir
table path file p_results_file=@results.p_results.tsv dir results_dir disp "P Results Aggregated" parent results_cat class_level results
path file p_results_plot=@results.p_results.pdf dir results_dir disp "P Results Plot" parent results_cat class_level results
path file p_results_params_files=@results.p_results_params_files.txt dir results_dir disp "P Results Params Files" parent results_cat class_level results
table path file p_results_geneset_info_file=@results.p_results_geneset_info_file.tsv dir results_dir disp "P Results Geneset Info Files" parent results_cat class_level results
path file p_results_plot_log_file=@results.p_results_plot.log dir results_dir disp "P Results Plot Log" parent results_cat class_level results

# Trait Group Level ==============================
table path file trait_group_null_rs_file=@trait_group.null_rs.tsv dir trait_group_dir disp "Trait Group Null RS File" parent trait_group_cat class_level trait_group

# TRAIT LEVEL ==============================
path file trait_gwas_file=@trait.sumstats.gz dir trait_dir disp "Trait GWAS File" parent trait_cat class_level trait
table path file trait_gene_list_file=@trait.gene_list.tsv dir trait_dir disp "Trait Gene List File" parent trait_cat class_level trait
table path file trait_ground_truth_file=@trait.ground_truth.tsv dir trait_dir disp "Trait Ground Truth File" parent trait_cat class_level trait
path file trait_gwas_inflated_file=@trait.inflated_se.sumstats.gz dir trait_dir disp "Trait GWAS - Inflated SE File" parent trait_cat class_level trait
path file trait_gwas_inflated_log_file=@trait.inflated_se.log dir trait_dir disp "Trait GWAS - Inflated SE Log File" parent trait_cat class_level trait

# Model LEVEL ==============================
table path file geneset_list_info_file=@model.geneset_list.tsv dir model_dir disp "Geneset List Info File" parent model_cat class_level model
path file model_embedding_info_file=@model.embeddings.json dir model_dir disp "Embedding Info File" parent model_cat class_level model
table path file model_complexity_file=@model.complexity.tsv dir model_dir disp "Model Complexity File" parent model_cat class_level model
table path file flattened_model_geneset_list_info_file=@model.flattened_geneset_list.tsv dir model_dir disp "Flattened Geneset List Info File" parent model_cat class_level model

# GENESETS LEVEL ==============================
genesets_trunk=@genesets dir genesets_dir
path file geneset_list_metadata_file=@genesets.metadata.txt dir genesets_dir disp "Geneset List Metadata File" parent genesets_cat class_level genesets
path file geneset_list_embedding_info_file=@genesets.embeddings.json dir genesets_dir disp "Embedding Info File" parent genesets_cat class_level genesets
path file geneset_list_embedding_matrix_file=@genesets.embeddings.npy dir genesets_dir disp "Embedding Matrix File" parent genesets_cat class_level genesets
path file geneset_list_embedding_log_file=@genesets.embeddings.log dir genesets_dir disp "Embedding Log File" parent genesets_cat class_level genesets
path file geneset_list_trait_similarity_log_file=@genesets.trait_similarity.log dir genesets_dir disp "Geneset to Trait Similarity Log File" parent genesets_cat class_level genesets
table path file geneset_list_trait_similarity_file=@genesets.trait_similarity.tsv dir genesets_dir disp "Geneset to Trait Similarity File" parent genesets_cat class_level genesets
path file geneset_list_trait_similarity_distribution_plot_file=@genesets.trait_similarity.distribution_plot.pdf dir genesets_dir disp "Geneset to Trait Similarity Distribution Plot File" parent genesets_cat class_level genesets
path file geneset_list_trait_similarity_distribution_plot_npz_file=@genesets.trait_similarity.distribution_plot.npz dir genesets_dir disp "Geneset to Trait Similarity Distribution Plot NPZ File" parent genesets_cat class_level genesets
table path file geneset_list_trait_similarity_summary_file=@genesets.trait_similarity.summary.tsv dir genesets_dir disp "Geneset to Trait Similarity Summary File" parent genesets_cat class_level genesets

# EXPERIMENT LEVEL ==============================
experiment_trunk=@experiment dir experiment_dir
path file run_trait_group_validation_experiment_log_file=@experiment.run_trait_group_validation_experiment.log dir experiment_dir disp "Run Trait Group Validation Experiment Log" parent experiment_cat class_level experiment
table path file experiment_gene_stats_out_file=@experiment.gene_stats.out dir experiment_dir disp "Gene Stats Out" parent experiment_cat class_level experiment
table path file experiment_gene_set_stats_out_file=@experiment.gene_set_stats.out dir experiment_dir disp "Gene Set Stats Out" parent experiment_cat class_level experiment
table path file experiment_gene_gene_set_stats_out_file=@experiment.gene_gene_set_stats.out dir experiment_dir disp "Gene Gene Set Stats Out" parent experiment_cat class_level experiment
table path file experiment_params_out_file=@experiment.params.out dir experiment_dir disp "Params Out" parent experiment_cat class_level experiment
table path file experiment_factors_out_file=@experiment.factors.out dir experiment_dir disp "Factors Out" parent experiment_cat class_level experiment
table path file experiment_gene_clusters_out_file=@experiment.gene_clusters.out dir experiment_dir disp "Gene Clusters Out" parent experiment_cat class_level experiment
table path file experiment_gene_set_clusters_out_file=@experiment.gene_set_clusters.out dir experiment_dir disp "Gene Set Clusters Out" parent experiment_cat class_level experiment
table path file experiment_factors_anchor_out_file=@experiment.factors_anchor.out dir experiment_dir disp "Factors Anchor Out" parent experiment_cat class_level experiment
table path file experiment_gene_anchor_clusters_out_file=@experiment.gene_anchor_clusters.out dir experiment_dir disp "Gene Anchor Clusters Out" parent experiment_cat class_level experiment
table path file experiment_gene_set_anchor_clusters_out_file=@experiment.gene_set_anchor_clusters.out dir experiment_dir disp "Gene Set Anchor Clusters Out" parent experiment_cat class_level experiment
table path file experiment_postprocess_common_trait_validation_experiment_log_file=@experiment.postprocess_common_trait_validation_experiment.log dir experiment_dir disp "Postprocess Common Trait Validation Experiment Log" parent experiment_cat class_level experiment
table path file experiment_cumulative_precision_out_file=@experiment.cumulative_precision.tsv dir experiment_dir disp "Cumulative Precision Out" parent experiment_cat class_level experiment
path file experiment_cumulative_precision_plot_out_file=@experiment.cumulative_precision.pdf dir experiment_dir disp "Cumulative Precision Plot Out" parent experiment_cat class_level experiment
path file experiment_gene_set_hist_file=@experiment.gene_set_hist.pdf dir experiment_dir disp "Geneset Histogram Out" parent experiment_cat class_level experiment
path file experiment_gene_gene_set_hist_file=@experiment.gene_gene_set_hist.pdf dir experiment_dir disp "Gene Geneset Histogram Out" parent experiment_cat class_level experiment
path file experiment_geneset_embeddings_log_file=@experiment.geneset_embeddings.log dir experiment_dir disp "Geneset Embeddings Log File" parent experiment_cat class_level experiment
table path file experiment_geneset_embeddings_file=@experiment.geneset_embeddings.tsv dir experiment_dir disp "Geneset to Trait Embeddings File" parent experiment_cat class_level experiment
path file experiment_geneset_embeddings_plot_out_file=@experiment.geneset_embeddings.pdf dir experiment_dir disp "Geneset to Trait Embeddings Plot" parent experiment_cat class_level experiment
table path file experiment_geneset_embeddings_spearman_correlations_file=@experiment.geneset_embeddings.spearman_correlations.tsv dir experiment_dir disp "Geneset to Trait Spearman Correlations File" parent experiment_cat class_level experiment
table path file experiment_relative_success_file=@experiment.relative_success.tsv dir experiment_dir disp "Relative Success File" parent experiment_cat class_level experiment
table path file experiment_model_selection_null_dist_file=@experiment.model_selection_null_dist.tsv dir experiment_dir disp "Model Selection Null Dist File" parent experiment_cat class_level experiment

# P-EXPERIMENT LEVEL ==============================
pexp_trunk=@p_experiment dir p_experiment_dir
path file p_experiment_trait_validation_experiment_log_file=@p_experiment.trait_validation_experiment.log dir p_experiment_dir disp "Trait Validation Experiment Log" parent p_experiment_cat class_level p_experiment
table path file geneset_list_sampled_file=@p_experiment.geneset_list_sampled.txt dir p_experiment_dir disp "Geneset List Sampled File" parent p_experiment_cat class_level p_experiment
table path file geneset_list_sampled_stats_file=@p_experiment.geneset_list_sampled_stats.tsv dir p_experiment_dir disp "Geneset List Sampled Stats File" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_stats_out_file=gene_stats.out dir p_experiment_dir disp "Gene Stats Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_set_stats_out_file=gene_set_stats.out dir p_experiment_dir disp "Gene Set Stats Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_gene_set_stats_out_file=gene_gene_set_stats.out dir p_experiment_dir disp "Gene Gene Set Stats Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_params_out_file=params.out dir p_experiment_dir disp "Params Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_factors_out_file=factors.out dir p_experiment_dir disp "Factors Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_clusters_out_file=gene_clusters.out dir p_experiment_dir disp "Gene Clusters Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_set_clusters_out_file=gene_set_clusters.out dir p_experiment_dir disp "Gene Set Clusters Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_factors_anchor_out_file=factors_anchor.out dir p_experiment_dir disp "Factors Anchor Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_anchor_clusters_out_file=gene_anchor_clusters.out dir p_experiment_dir disp "Gene Anchor Clusters Out" parent p_experiment_cat class_level p_experiment
table path file p_experiment_gene_set_anchor_clusters_out_file=gene_set_anchor_clusters.out dir p_experiment_dir disp "Gene Set Anchor Clusters Out" parent p_experiment_cat class_level p_experiment

# RUN LEVEL ==============================
run_trunk=@run dir run_dir
path file run_trait_validation_experiment_log_file=run_trait_validation_experiment.log dir run_dir disp "Run Trait Group Validation Experiment Log" parent run_cat class_level run
path file run_trait_validation_results_log_file=trait_validation_results.log dir run_dir disp "Trait Validation Results Log File" parent run_cat class_level run
table path file masked_genes_info_file=masked_genes_info.tsv dir run_dir disp "Masked Genes Info File" parent run_cat class_level run
table path file run_gene_stats_out_file=gene_stats.out dir run_dir disp "Gene Stats Out" parent run_cat class_level run
table path file run_gene_set_stats_out_file=gene_set_stats.out dir run_dir disp "Gene Set Stats Out" parent run_cat class_level run
table path file run_gene_gene_set_stats_out_file=gene_gene_set_stats.out dir run_dir disp "Gene Gene Set Stats Out" parent run_cat class_level run
table path file run_params_out_file=params.out dir run_dir disp "Params Out" parent run_cat class_level run
table path file run_factors_out_file=factors.out dir run_dir disp "Factors Out" parent run_cat class_level run
table path file run_gene_clusters_out_file=gene_clusters.out dir run_dir disp "Gene Clusters Out" parent run_cat class_level run
table path file run_gene_set_clusters_out_file=gene_set_clusters.out dir run_dir disp "Gene Set Clusters Out" parent run_cat class_level run
table path file run_factors_anchor_out_file=factors_anchor.out dir run_dir disp "Factors Anchor Out" parent run_cat class_level run
table path file run_gene_anchor_clusters_out_file=gene_anchor_clusters.out dir run_dir disp "Gene Anchor Clusters Out" parent run_cat class_level run
table path file run_gene_set_anchor_clusters_out_file=gene_set_anchor_clusters.out dir run_dir disp "Gene Set Anchor Clusters Out" parent run_cat class_level run
table path file run_masked_genes_out_file=masked_genes.tsv dir run_dir disp "Masked Genes Out" parent run_cat class_level run
table path file run_precision_out_file=precision.tsv dir run_dir disp "Precision Out" parent run_cat class_level run
path file run_precision_plot_out_file=precision.png dir run_dir disp "Precision Plot Out" parent run_cat class_level run

# MASK LEVEL ==============================
mask_trunk=@mask dir mask_dir
path file mask_trait_validation_experiment_log_file=mask_trait_validation_experiment.log dir mask_dir disp "Mask Trait Validation Experiment Log" parent mask_cat class_level mask
table path file mask_gene_stats_out_file=gene_stats.out dir mask_dir disp "Gene Stats Out" parent mask_cat class_level mask
table path file mask_gene_set_stats_out_file=gene_set_stats.out dir mask_dir disp "Gene Set Stats Out" parent mask_cat class_level mask
table path file mask_gene_gene_set_stats_out_file=gene_gene_set_stats.out dir mask_dir disp "Gene Gene Set Stats Out" parent mask_cat class_level mask
table path file mask_params_out_file=params.out dir mask_dir disp "Params Out" parent mask_cat class_level mask
table path file mask_factors_out_file=factors.out dir mask_dir disp "Factors Out" parent mask_cat class_level mask
table path file mask_gene_clusters_out_file=gene_clusters.out dir mask_dir disp "Gene Clusters Out" parent mask_cat class_level mask
table path file mask_gene_set_clusters_out_file=gene_set_clusters.out dir mask_dir disp "Gene Set Clusters Out" parent mask_cat class_level mask
table path file mask_factors_anchor_out_file=factors_anchor.out dir mask_dir disp "Factors Anchor Out" parent mask_cat class_level mask
table path file mask_gene_anchor_clusters_out_file=gene_anchor_clusters.out dir mask_dir disp "Gene Anchor Clusters Out" parent mask_cat class_level mask
table path file mask_gene_set_anchor_clusters_out_file=gene_set_anchor_clusters.out dir mask_dir disp "Gene Set Anchor Clusters Out" parent mask_cat class_level mask

#=======================================================================================================================
#COMMANDS

# VALIDATION PROJECT LEVEL ==============================
short cmd model_selction_analysis_cmd=$run_uv_cmd \
    $pigean_bin_dir/model_selection_analysis.py \
    !{input:--config:models_config_file} \
    !{input:--phenotypes:phenotype_file} \
    !{input;--experiment-metrics-file;experiment_cumulative_precision_out_file;allow_empty=1;optional=1} \
    !{input;--experiment-phenotypic-similarity-file;experiment_geneset_embeddings_file;allow_empty=1;optional=1} \
    !{input;--experiment-relative-success-file;experiment_relative_success_file;allow_empty=1;optional=1} \
    !{input;--experiment-random-ndcg-file;experiment_model_selection_null_dist_file;allow_empty=1;optional=1} \
    !{input;--trait-group-null-rs-file;trait_group_null_rs_file;allow_empty=1;optional=1} \
    !{input:--model-complexity-files:model_complexity_file} \
    !{prop:--models:model} \
    !{input:--model-embedding-info-file:model_embedding_info_file} \
    !{output:--output-plot-file:model_selection_plot_out_file} \
    !{output:--output-trait-metrics-file:model_selection_trait_metrics_out_file} \
    !{output:--output-collapsed-metrics-file:model_selection_collapsed_metrics_out_file} \
    --mechanism-metric-name ndcg \
    --ndcg-similarity-threshold 0.4 ; \
    # > !{output::model_selection_log_file} 2>&1; \
    class_level validation run_if validation:eq:geneset_analysis

short cmd analyze_geneset_similarities_across_libraries_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/analyze_geneset_similarities_across_libraries.py \
    !{input;--geneset-list-stat-files;geneset_list_trait_similarity_summary_file;optional=1;allow_empty=1} \
    !{input;--geneset-list-plot-files;geneset_list_trait_similarity_distribution_plot_npz_file;optional=1;allow_empty=1} \
    !{prop:--geneset-list-names:genesets} \
    !{output:--output-statistics-file:geneset_list_stats_file} \
    !{output:--output-distribution-plot-file:geneset_list_stats_plot_file}; \
    class_level validation run_if validation:eq:geneset_analysis

short cmd filter_geneset_libraries_cmd=$run_uv_cmd \
    python3 $pigean_bin_dir/analyze_geneset_libraries.py \
    !{input:--geneset-stats-file:experiment_gene_set_stats_out_file} \
    !{prop:--experiment-name:experiment} \
    !{input:--geneset-info-file:geneset_list_info_file} \
    !{prop:--model-name:model} \
    !{output:--output-geneset-library-stats-file:geneset_libraries_stats_file}; \
    class_level validation run_if validation:eq:geneset_analysis

short cmd analyze_geneset_libraries_cmd=$run_uv_cmd \
    python3 $pigean_bin_dir/analyze_geneset_libraries.py \
    !{input:--geneset-library-stats-file:geneset_libraries_stats_file} \
    !{output:--output-geneset-library-plot-file:geneset_libraries_plot_file}; \
    class_level validation run_if validation:eq:geneset_analysis

short cmd make_cross_phenotype_embeddings_cmd=$run_uv_cmd \
    python3 $pigean_bin_dir/make_cross_phenotype_embeddings.py \
    !{input:--phenotypes-file:phenotype_file} \
    --embedding-column phenotype_name \
    !{output:--output-embeddings-file:cross_phenotype_embeddings_file} \
    !{output:--output-similarity-matrix-file:cross_phenotype_similarity_matrix_file} \
    --cluster-params affinity=precomputed; \
    class_level validation run_if validation:eq:geneset_analysis

short cmd plot_cross_phenotype_embeddings_cmd=$run_uv_cmd \
    $pigean_bin_dir/make_cross_phenotype_embeddings.py \
    !{input:--phenotypes-file:phenotype_file} \
    !{input:--sample-size-file:phenotype_sample_size_file} \
    !{input:--embeddings-file:cross_phenotype_embeddings_file} \
    --embedding-column phenotype_name \
    # !{input:--similarity-matrix-file:cross_phenotype_similarity_matrix_file} \
    !{output:--output-cluster-visualization-file:cross_phenotype_cluster_visualization_file} \
    --only-portal-traits \
    # --cluster-model AgglomerativeClustering \
    # --cluster-params n_clusters=20 metric=precomputed linkage=average; \
    # --cluster-model AffinityPropagation \
    --cluster-params n_clusters=20; \
    class_level validation run_if validation:eq:geneset_analysis


# RESULTS LEVEL ==============================
short cmd collect_params_files_cmd=printf "%s\n" !{input::p_experiment_params_out_file:optional=1} | grep -E ".*!{prop::results:model_name:allow_empty=1}" > !{output::p_results_params_files}; \
    class_level results run_if and,validation:eq:p_validation,results:ne:p_results

# short cmd collect_params_files_all_cmd=printf "%s\n" !{input::p_experiment_params_out_file:optional=1} > !{output::p_results_params_files}; \
#     class_level results run_if and,validation:eq:p_validation,results:eq:p_results

short cmd collect_sampled_geneset_info_files_cmd=$smart_cut_cmd \
    \$( first=1; \
        i=1; \
        for f in !{input::geneset_list_sampled_stats_file:optional=1}; do \
        if [[ \$f =~ .*!{prop::results:model_name:allow_empty=1} ]]; then \
            if [[ \$first -eq 1 ]]; then \
                echo --file \$f; \
                first=0; \
            else \
                echo --file \$f --exclude-row \$i,1; \
            fi; \
            i=\$((i+1)); \
        fi; \
    done) --tab-delim > !{output::p_results_geneset_info_file}; \
    class_level results run_if and,validation:eq:p_validation,results:ne:p_results

short cmd make_p_results_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/pigean_p_analysis.py \
    !{input:--params-input-files:p_results_params_files} \
    !{input:--geneset-info-file:p_results_geneset_info_file} \
    !{output:--output-table-file:p_results_file} \
    !{output:--output-plot-file:p_results_plot} \
    !{prop:--model-name:results:model_name:if_prop=model_name:allow_empty=1}; \
    class_level results run_if and,validation:eq:p_validation,results:ne:p_results

short cmd make_main_p_results_cmd=$smart_cut_cmd \
    \$( first=1; \
        i=1; \
        results_dir=\$(dirname !{raw::results:*results_trunk}); \
        for f in !{prop;;results;all_instances=1;if_prop=results:ne:p_results;optional=1}; do \
        if [[ -f "\$results_dir/\$f.p_results.tsv" ]]; then \
            if [[ \$first -eq 1 ]]; then \
                echo --file \$results_dir/\$f.p_results.tsv; \
                first=0; \
            else \
                echo --file \$results_dir/\$f.p_results.tsv --exclude-row \$i,1; \
            fi; \
            i=\$((i+1)); \
        fi; \
    done) --tab-delim > !{output::p_results_file}; \
    class_level results run_if and,validation:eq:p_validation,results:eq:p_results

local cmd make_main_p_results_plot_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/pigean_p_analysis.py \
    !{input:--aggregate-p-results-file:p_results_file} \
    !{output:--output-plot-file:p_results_plot} > !{output::p_results_plot_log_file} 2>&1; \
    class_level results run_if and,validation:eq:p_validation,results:eq:p_results

# Trait Group Level ==============================
short cmd calculate_trait_group_null_rs_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/calculate_trait_group_null_rs.py \
    !{prop:--trait-group:trait_group} \
    !{prop:--trait:trait} \
    --portal-mesh-mapping-file $pigean_raw_dir/portal_to_mesh_curated_collected.tsv \
    !{output:--output-file:trait_group_null_rs_file}; \
    class_level trait_group run_if or,trait_group:eq:common,trait_group:eq:rare

# TRAIT LEVEL ==============================
local cmd make_gold_standard_genes_cmd=jq -r '."!{prop::trait}"[]' !{input::gold_standard_genes_file} > !{output::trait_ground_truth_file}; \
    class_level trait run_if trait_group:eq:common

# short cmd simulate_gwas_se_inflation_cmd=zcat \
#     !{input::trait_gwas_file} \
#     | awk 'BEGIN{FS=OFS="\t"} NR==1 {print} NR>1 { \$4 = \$4 / !{prop::trait:standard_error_inflation_factor}; print }' \
#     | gzip > \
#     !{output::trait_gwas_inflated_file}; \
#     class_level trait run_if trait_group:eq:well_powered

short cmd simulate_gwas_se_inflation_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/simulate_gwas_se_inflation.py \
    !{input:--input:trait_gwas_file} \
    !{output:--output-file:trait_gwas_inflated_file} \
    !{prop:--n-reduction-factor:trait:standard_error_inflation_factor} \
    --seed 42 > !{output::trait_gwas_inflated_log_file} 2>&1; \
    class_level trait run_if trait_group:eq:well_powered

# MODEL LEVEL ==============================
local cmd make_geneset_lists_cmd=$run_uv_cmd \
    python3 $pigean_bin_dir/make_geneset_lists.py \
    !{input:--config:models_config_file} \
    !{prop:--model-name:model} \
    !{output:--output-file:geneset_list_info_file}; \
    class_level model

short cmd calculate_model_complexity_cmd=$run_uv_cmd \
    python3 $pigean_bin_dir/calculate_model_complexity.py \
    !{input:--config:models_config_file} \
    !{prop:--model-name:model} \
    !{output:--output-file:model_complexity_file}; \
    class_level model

short cmd make_model_embedding_info_file_cmd=\
    genesets_dirs=$(echo !{raw::genesets:*genesets_trunk}) && \
    $run_uv_cmd \
    python3 $pigean_bin_dir/make_model_embedding_info.py \
    !{input:--config:models_config_file} \
    !{prop:--model-name:model} \
    --geneset-list-dirs "\$genesets_dirs" \
    !{input:--model-geneset-list-info-file:geneset_list_info_file} \
    !{output:--output-file:model_embedding_info_file}; \
    class_level model

short cmd flatten_model_genesets_cmd=$run_uv_cmd \
    python3 $pigean_bin_dir/flatten_model_genesets.py \
    # !{input:--model-geneset-list-info-file:geneset_list_info_file} \
    !{input:--embedding-info-file:model_embedding_info_file} \
    --only-geneset-names \
    !{output:--output-file:flattened_model_geneset_list_info_file}; \
    class_level model

# EXPERIMENT LEVEL ==============================
# local cmd run_trait_validation_experiment=echo "Running common trait validation experiment" && \
#     echo "Trait group: !{prop::trait_group}" && \
#     echo "Traits: !{prop::trait}" && \
#     echo "Trait GWAS File: !{input;;trait_gwas_file}" && \
#     echo "Geneset List File: !{input;;geneset_list_info_file;if_prop=model:eq:@model_name}" && \
#     echo "Model: !{prop::experiment:model_name}" > !{output::run_trait_group_validation_experiment_log_file} 2>&1; \
#     class_level experiment

# short cmd run_trait_group_validation_experiment_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
#     output_dir=$(dirname !{raw::experiment:*experiment_trunk}) && \
#     python3 $pigean_bin_dir/run_validation_experiment.py \
#     !{prop:--trait:trait} \
#     !{input;--trait-gwas-file;trait_gwas_file;if_prop=trait_group:eq:common;allow_empty=1} \
#     !{input;--trait-gene-list-file;trait_gene_list_file;if_prop=trait_group:eq:rare;allow_empty=1} \
#     !{input;--geneset-list-file;geneset_list_info_file;if_prop=model:eq:@model_name} \
#     !{prop:--output-prefix:experiment} \
#     --output-dir "\$output_dir" \
#     --max-number-gene-sets 5000 \
#     --debug-level 3 \
#     --gene-filter-value 1 \
#     --gene-set-filter-value 0.01 \
#     --bin-dir $pigean_bin_dir \
#     --trait-group !{prop::trait_group} \
#     --test-mode \
#     --temp-dir $pigean_temp_dir > !{output::run_trait_group_validation_experiment_log_file} 2>&1; \
#     class_level experiment

# Collect all run experiments into a single file
short cmd collect_run_experiments_cmd=\
    set -e; \
    stats_files=( !{input::run_gene_stats_out_file:optional=1} ); \
    genesets_files=( !{input::run_gene_set_stats_out_file:optional=1} ); \
    geneset_gene_files=( !{input::run_gene_gene_set_stats_out_file:optional=1} ); \
    out_stats="!{output::experiment_gene_stats_out_file}"; \
    out_genesets="!{output::experiment_gene_set_stats_out_file}"; \
    out_geneset_genes="!{output::experiment_gene_gene_set_stats_out_file}"; \
    \
    first=1; \
    for i in "\${!stats_files[@]}"; do \
        f_stats="\${stats_files[\$i]}"; \
        f_genesets="\${genesets_files[\$i]}"; \
        f_geneset_genes="\${geneset_gene_files[\$i]}"; \
        \
        if [[ -s "\$f_stats" ]]; then \
            if [[ \$first -eq 1 ]]; then \
                head -n 1 "\$f_stats" > "\$out_stats"; \
            fi; \
            tail -n +2 "\$f_stats" >> "\$out_stats"; \
        fi; \
        \
        if [[ -s "\$f_genesets" ]]; then \
            if [[ \$first -eq 1 ]]; then \
                head -n 1 "\$f_genesets" > "\$out_genesets"; \
            fi; \
            tail -n +2 "\$f_genesets" >> "\$out_genesets"; \
        fi; \
        \
        if [[ -s "\$f_geneset_genes" ]]; then \
            if [[ \$first -eq 1 ]]; then \
                head -n 1 "\$f_geneset_genes" > "\$out_geneset_genes"; \
                first=0; \
            fi; \
            tail -n +2 "\$f_geneset_genes" >> "\$out_geneset_genes"; \
        fi; \
    done; \
    class_level experiment

short cmd calculate_experiment_geneset_embeddings_cmd=$run_uv_cmd \
    $pigean_bin_dir/calculate_experiment_geneset_embeddings.py \
    !{input:--geneset-file:experiment_gene_set_stats_out_file} \
    !{input:--config:models_config_file} \
    !{input;--model-embedding-info-file;model_embedding_info_file;if_prop=model:eq:@model_name} \
    !{input;--phenotype-file;phenotype_file} \
    !{input;--geneset-list-plot-files;geneset_list_trait_similarity_distribution_plot_npz_file;optional=1;allow_empty=1} \
    !{prop:--geneset-list-names:genesets} \
    !{prop:--model-name:experiment:model_name} \
    !{input:--geneset-list-trait-similarity-files:geneset_list_trait_similarity_file} \
    --min-sort-by-value 0.01 \
    --sort-by beta \
    !{output:--output-file:experiment_geneset_embeddings_file} \
    !{output:--output-spearman-correlations-file:experiment_geneset_embeddings_spearman_correlations_file} \
    !{prop:--trait-group:trait_group} \
    > !{output::experiment_geneset_embeddings_log_file} 2>&1; \
    class_level experiment

short cmd analyze_model_genesets_cmd=$run_uv_cmd \
    $pigean_bin_dir/analyze_model_genesets.py \
    !{input:--gene-stats-file:experiment_gene_stats_out_file} \
    !{input:--geneset-file:experiment_gene_set_stats_out_file} \
    !{input:--geneset-genes-file:experiment_gene_gene_set_stats_out_file} \
    !{output:--output-geneset-hist-file:experiment_gene_set_hist_file} \
    !{output:--output-geneset-genes-hist-file:experiment_gene_gene_set_hist_file} \
    !{input:--model-info-file:models_config_file} \
    --min-sort-by-value 0.01 \
    --sort-by beta; \
    class_level experiment

short cmd calculate_relative_success_cmd=$run_uv_cmd \
    $pigean_bin_dir/relative_success_validation_wrapper.py \
    !{input:--gene-stats-file:experiment_gene_stats_out_file} \
    --portal-mesh-mapping-file $pigean_raw_dir/portal_to_mesh_curated_collected.tsv \
    !{output:--output-file:experiment_relative_success_file} \
    !{prop:--model-name:experiment:model_name} \
    !{prop:--trait-group:trait_group}; \
    class_level experiment

short cmd calculate_model_selection_null_dist_cmd=$run_uv_cmd \
    $pigean_bin_dir/calculate_model_selection_null_dist.py \
    !{input:--geneset-trait-embeddings-file:experiment_geneset_embeddings_file} \
    !{input;--flattened-model-geneset-list-info-file;flattened_model_geneset_list_info_file;if_prop=model:eq:@model_name} \
    !{input:--phenotype-file:phenotype_file} \
    !{prop:--model-name:experiment:model_name} \
    --ndcg-similarity-threshold 0.4 \
    !{output:--output-file:experiment_model_selection_null_dist_file}; \
    class_level experiment



# first=1; \
#     for f in !{input::run_gene_stats_out_file:optional=1}; do \
#         if [[ -s "\$f" ]]; then \
#             if [[ \$first -eq 1 ]]; then \
#                 head -n 1 "\$f" > !{output::experiment_gene_stats_out_file}; \
#                 first=0; \
#             fi; \
#             tail -n +2 "\$f" >> !{output::experiment_gene_stats_out_file}; \
#         fi; \
#     done; \
#     class_level experiment

# GENESETS LEVEL ==============================

short cmd make_geneset_list_embeddings_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate; \
    python3 $pigean_bin_dir/make_geneset_embeddings.py \
    !{input:--config:models_config_file} \
    !{prop:--geneset-list-name:genesets} \
    !{input;--geneset-list-metadata-file;geneset_list_metadata_file;allow_empty=1;optional=1} \
    !{output:--output-info-file:geneset_list_embedding_info_file} \
    !{output:--output-matrix-file:geneset_list_embedding_matrix_file} \
    --batch-size 64 \
    > !{output::geneset_list_embedding_log_file} 2>&1; \
    class_level genesets

short cmd embed_genset_list_to_all_traits_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/embed_geneset_list_to_all_traits.py \
    !{input:--embedding-info-file:geneset_list_embedding_info_file} \
    !{input:--embedding-matrix-file:geneset_list_embedding_matrix_file} \
    # !{input:--phenotype-file:phenotype_file} \
    !{prop:--trait:trait} \
    !{prop:--geneset-list-name:genesets} \
    !{output:--output-table-file:geneset_list_trait_similarity_file} \
    !{output:--output-distribution-plot-file:geneset_list_trait_similarity_distribution_plot_file} \
    !{output:--output-summary-file:geneset_list_trait_similarity_summary_file} \
    > !{output::geneset_list_trait_similarity_log_file} 2>&1; \
    class_level genesets

# P-EXPERIMENT LEVEL ==============================

short cmd pexp_trait_validation_experiment_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    output_dir=$(dirname !{raw::p_experiment:*pexp_trunk}) && \
    python3 $pigean_bin_dir/run_validation_experiment.py \
    !{prop;--trait;trait;if_prop=trait:eq:@trait_name} \
    !{input;--trait-gwas-file;trait_gwas_inflated_file;if_prop=trait_group:eq:well_powered;if_prop=trait:eq:@trait_name} \
    !{input:--geneset-list-file:geneset_list_sampled_file} \
    --output-dir "\$output_dir" \
    --max-number-gene-sets 5000 \
    --debug-level 3 \
    --gene-filter-value 1 \
    --gene-set-filter-value 0.01 \
    --bin-dir $pigean_bin_dir \
    --filter-gene-set-p 0.005 \
    --no-correct-betas-mean \
    --update-hyper p \
    !{prop:--trait-group:trait_group} \
    --temp-dir $pigean_temp_dir > !{output::p_experiment_trait_validation_experiment_log_file} 2>&1; \
    class_level p_experiment run_if trait_group:eq:well_powered

short cmd pexp_calc_sampled_geneset_stats_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/calc_sampled_geneset_stats.py \
    !{input:--input-file:geneset_list_sampled_file} \
    !{output:--output-file:geneset_list_sampled_stats_file} \
    class_level p_experiment

short cmd sample_geneset_list_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    python3 $pigean_bin_dir/sample_geneset_list.py \
    !{input;--input;geneset_list_info_file;if_prop=model:eq:@model_name} \
    !{output:--output-file:geneset_list_sampled_file} \
    !{prop:--prefix:p_experiment} \
    --temp-dir $pigean_temp_dir \
    !{prop:--sample-size-fraction:p_experiment:geneset_size_fraction} \
    --seed 42; \
    class_level p_experiment

# RUN LEVEL ==============================

short cmd run_trait_validation_experiment_cmd=\
    output_dir=$(dirname !{raw::run:*run_trunk}) && \
    $run_uv_cmd \
    python3 $pigean_bin_dir/run_validation_experiment.py \
    !{prop;--trait;trait;if_prop=trait:eq:@trait_name} \
    !{input;--trait-gwas-file;trait_gwas_file;if_prop=trait_group:eq:common;if_prop=trait:eq:@trait_name;allow_empty=1} \
    !{input;--trait-gene-list-file;trait_gene_list_file;if_prop=trait_group:eq:rare;if_prop=trait:eq:@trait_name;allow_empty=1} \
    !{input;--geneset-list-file;geneset_list_info_file;if_prop=model:eq:@model_name} \
    --output-dir "\$output_dir" \
    --max-number-gene-sets 5000 \
    --debug-level 1 \
    --gene-filter-value 1 \
    --gene-set-filter-value 0.01 \
    --bin-dir $pigean_bin_dir \
    --trait-group !{prop::trait_group} \
    --filter-gene-set-p 0.005 \
    --p-noninf 0.0005 \
    --update-hyper none \
    --use-p-noninf-as-backup \
    --temp-dir $pigean_temp_dir > !{output::run_trait_validation_experiment_log_file} 2>&1; \
    class_level run run_if trait_group:eq:common


short cmd run_portal_regression_test_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
    output_dir=$(dirname !{raw::run:*run_trunk}) && \
    python3 $pigean_bin_dir/run_validation_experiment.py \
    !{prop;--trait;trait;if_prop=trait:eq:@trait_name} \
    !{input;--trait-gwas-file;trait_gwas_file;if_prop=trait_gwas_file;if_prop=trait:eq:@trait_name;allow_empty=1} \
    !{input;--trait-gene-list-file;trait_gene_list_file;if_prop=trait_gene_list_file;if_prop=trait:eq:@trait_name;allow_empty=1} \
    !{input;--geneset-list-file;geneset_list_info_file;if_prop=model:eq:@model_name} \
    --output-dir "\$output_dir" \
    --max-number-gene-sets 5000 \
    --debug-level 1 \
    --gene-filter-value 1 \
    --gene-set-filter-value 0.01 \
    --bin-dir $pigean_bin_dir \
    !{prop;--trait-group;trait;trait_type;if_prop=trait:eq:@trait_name} \
    --filter-gene-set-p 0.005 \
    --p-noninf 0.0005 \
    --update-hyper none \
    --use-p-noninf-as-backup \
    --temp-dir $pigean_temp_dir > !{output::run_trait_validation_experiment_log_file} 2>&1; \
    class_level run run_if trait_group:eq:portal_traits

# short cmd run_masked_trait_validation_experiment_cmd=echo !{prop::mask:mask_percentage} > !{output::run_trait_validation_experiment_log_file}; \
#     class_level run run_if trait_group:eq:rare

# short cmd run_masked_trait_validation_experiment_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
#     output_dirs=$(for f in !{raw::mask:*mask_trunk}; do echo $(dirname \$f); done) && \
#     output_dir=$(dirname !{raw::run:*run_trunk}) && \
#     python3 $pigean_bin_dir/run_validation_experiment.py \
#     !{prop;--trait;trait;if_prop=trait:eq:@trait_name} \
#     !{input;--trait-gwas-file;trait_gwas_file;if_prop=trait_group:eq:common;if_prop=trait:eq:@trait_name;allow_empty=1} \
#     !{input;--trait-gene-list-file;trait_gene_list_file;if_prop=trait_group:eq:rare;if_prop=trait:eq:@trait_name;allow_empty=1} \
#     !{input;--geneset-list-file;geneset_list_info_file;if_prop=model:eq:@model_name} \
#     --output-dirs \$output_dirs \
#     --output-dir \$output_dir \   
#     --mask-log-files !{output::mask_trait_validation_experiment_log_file} \
#     --max-number-gene-sets 1000 \
#     --debug-level 3 \
#     --gene-filter-value 1 \
#     --gene-set-filter-value 0.01 \
#     --bin-dir $pigean_bin_dir \
#     !{prop:--trait-group:trait_group} \
#     --mask-percentages !{prop::mask:mask_percentage} \
#     --number-masking-trials 10 \
#     --p-noninf 0.0005 \
#     --update-hyper none \
#     --use-p-noninf-as-backup \
#     --top-k 1000 \
#     --masked-genes-info-file !{output::masked_genes_info_file} \
#     --run-parallel \
#     --num-workers 30 \
#     --temp-dir $pigean_temp_dir > !{output::run_trait_validation_experiment_log_file} 2>&1; \
#     class_level run run_if trait_group:eq:rare

# Analyze rare trait validation experiment
# short cmd analyze_rare_trait_validation_experiment_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
#     python3 $pigean_bin_dir/analyze_validation_experiment.py \
#     !{prop:--trait-group:trait_group} \
#     !{input:--gene-stats-out-file:run_gene_stats_out_file} \
#     !{input:--gene-set-stats-out-file:run_gene_set_stats_out_file} \
#     !{input:--gene-gene-set-stats-out-file:run_gene_gene_set_stats_out_file} \
#     !{input:--masked-genes-info-file:masked_genes_info_file} \
#     !{output:--masked-genes-out-file:run_masked_genes_out_file} \
#     !{output:--precision-out-file:run_precision_out_file} \
#     !{output:--precision-plot-out-file:run_precision_plot_out_file} > !{output::run_trait_validation_results_log_file} 2>&1; \
#     class_level run run_if trait_group:eq:rare

short cmd run_masked_trait_validation_experiment_cmd_v2=\
    output_dir=$(dirname !{raw::run:*run_trunk}) && \
    $run_uv_cmd \
    python3 $pigean_bin_dir/run_validation_experiment.py \
    !{prop;--trait;trait;if_prop=trait:eq:@trait_name} \
    !{input;--trait-gwas-file;trait_gwas_file;if_prop=trait_group:eq:common;if_prop=trait:eq:@trait_name;allow_empty=1} \
    !{input;--trait-gene-list-file;trait_gene_list_file;if_prop=trait_group:eq:rare;if_prop=trait:eq:@trait_name;allow_empty=1} \
    !{input;--geneset-list-file;geneset_list_info_file;if_prop=model:eq:@model_name} \
    --output-dir \$output_dir \   
    --max-number-gene-sets 1000 \
    --debug-level 3 \
    --gene-filter-value 1 \
    --gene-set-filter-value 0.01 \
    --bin-dir $pigean_bin_dir \
    !{prop:--trait-group:trait_group} \
    --p-noninf 0.0005 \
    --update-hyper none \
    --use-p-noninf-as-backup \
    --temp-dir $pigean_temp_dir > !{output::run_trait_validation_experiment_log_file} 2>&1; \
    class_level run run_if trait_group:eq:rare

# Analyze common trait validation experiment
short cmd analyze_common_trait_validation_experiment_cmd=\
    $run_uv_cmd \
    python3 $pigean_bin_dir/analyze_validation_experiment.py \
    !{prop:--trait-group:trait_group} \
    !{input:--gene-stats-out-file:run_gene_stats_out_file} \
    !{input:--gene-set-stats-out-file:run_gene_set_stats_out_file} \
    !{input:--gene-gene-set-stats-out-file:run_gene_gene_set_stats_out_file} \
    !{input;--trait-ground-truth-file;trait_ground_truth_file;if_prop=trait:eq:@trait_name} \
    !{output:--precision-out-file:run_precision_out_file}  > !{output::run_trait_validation_results_log_file} 2>&1; \
    class_level run run_if trait_group:eq:common

# Analyze rare trait validation experiment
short cmd analyze_rare_trait_validation_experiment_cmd_v2=\
    $run_uv_cmd \
    python3 $pigean_bin_dir/analyze_validation_experiment.py \
    !{prop:--trait-group:trait_group} \
    !{input:--gene-stats-out-file:run_gene_stats_out_file} \
    !{input:--gene-set-stats-out-file:run_gene_set_stats_out_file} \
    !{input:--gene-gene-set-stats-out-file:run_gene_gene_set_stats_out_file} \
    !{output:--precision-out-file:run_precision_out_file}  > !{output::run_trait_validation_results_log_file} 2>&1; \
    class_level run run_if trait_group:eq:rare

short cmd analyze_common_trait_validation_experiment_cumulative_cmd=\
    $run_uv_cmd \
    $pigean_bin_dir/analyze_validation_experiment_cumulative.py \
    !{input:--precision-out-file:run_precision_out_file:optional=1:allow_empty=1} \
    # --only-prefix run \
    --only-prefix top__run \
    !{output:--cumulative-precision-out-file:experiment_cumulative_precision_out_file} \
    !{output:--cumulative-precision-plot-out-file:experiment_cumulative_precision_plot_out_file} \
    !{prop:--trait-group:trait_group}; \
    class_level experiment run_if trait_group:eq:common

short cmd analyze_rare_trait_validation_experiment_cumulative_cmd=\
    $run_uv_cmd \
    $pigean_bin_dir/analyze_validation_experiment_cumulative.py \
    !{input:--precision-out-file:run_precision_out_file:optional=1:allow_empty=1} \
    # --only-prefix run_v2 \
    --only-prefix top__run \
    !{output:--cumulative-precision-out-file:experiment_cumulative_precision_out_file} \
    !{output:--cumulative-precision-plot-out-file:experiment_cumulative_precision_plot_out_file} \
    !{prop:--trait-group:trait_group}; \
    class_level experiment run_if trait_group:eq:rare

# short cmd run_common_trait_validation_experiment_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
#     output_dir=$(dirname !{raw::experiment:*experiment_trunk}) && \
#     python3 $pigean_bin_dir/run_validation_experiment.py \
#     !{input:--trait-gwas-file:trait_gwas_file} \
#     !{input:--geneset-list-file:geneset_list_info_file} \
#     !{prop:--output-prefix:experiment} \
#     --output-dir "\$output_dir" \
#     --max-number-gene-sets 5000 \
#     --debug-level 3 \
#     --gene-filter-value 1 \
#     --gene-set-filter-value 0.01 \
#     --bin-dir $pigean_bin_dir \
#     --trait-group common \
#     --k-values 5 10 15 20 50 100 \
#     !{input:--ground-truth-file:trait_ground_truth_file} \
#     --temp-dir $pigean_temp_dir > !{output::run_common_trait_validation_experiment_log_file} 2>&1; \
#     class_level experiment run_if trait_group:eq:common

# short cmd postprocess_common_trait_validation_experiment_cmd=source /humgen/diabetes2/users/chase/lap/lap-venv/bin/activate && \
#     python3 $pigean_bin_dir/postprocess_validation_experiment.py \
#     !{input:--gene-stats-out-file:gene_stats_out_file} \
#     !{input:--gene-set-stats-out-file:gene_set_stats_out_file} \
#     !{input:--gene-gene-set-stats-out-file:gene_gene_set_stats_out_file} \
#     !{input:--params-out-file:params_out_file} \
#     !{input:--factors-out-file:factors_out_file} \
#     !{input:--gene-clusters-out-file:gene_clusters_out_file} \
#     !{input:--gene-set-clusters-out-file:gene_set_clusters_out_file} \
#     !{input:--factors-anchor-out-file:factors_anchor_out_file} \
#     !{input:--gene-anchor-clusters-out-file:gene_anchor_clusters_out_file} \
#     !{input:--gene-set-anchor-clusters-out-file:gene_set_anchor_clusters_out_file} \
#     !{prop:--output-prefix:experiment} \
#     --k-values 5 10 15 20 50 100 \
#     --trait-group common > !{output::postprocess_common_trait_validation_experiment_log_file} 2>&1; \
#     class_level experiment run_if trait_group:eq:common

#=======================================================================================================================
#PROPERTIES
prop mask_percentage=scalar
prop model_name=scalar
prop trait_name=scalar
prop geneset_size_fraction=scalar
prop standard_error_inflation_factor=scalar
prop trait_type=scalar
#=======================================================================================================================
#config files can be included
#common.cfg is required
lap_trunk=$lap_home/trunk
common_bin_dir=$lap_home/projects/common
!include $lap_trunk/config/common.cfg
pigean_bin_dir=$lap_home/projects/pigean/bin
pigean_raw_dir=$lap_home/projects/pigean/raw
pigean_scripts_dir=$lap_home/projects/pigean/scripts
pigean_temp_dir=$lap_home/projects/pigean/temp
run_uv_cmd=uv run --project $lap_home/projects/pigean
# OVERWRITES
max_jobs=1000
default_mem=10000
max_sge_batch=10000
# smp <cpu_number> -binding linear:<num_cores> means each job is mapped to a single core
# -binding linear:31 means map the 31 cores continugously. Probably not for your project
# -pe smp 31 means use 31 cores (all of the cores on the node)
bsub_opts=-pe smp 1
uger_short_time=06:00:00
bsub_short_time=06:00:00
#these are some useful scripts I wrote to process files
#this runs R-3.4
conditional_exec_cmd=perl $common_bin_dir/conditional_exec.pl
#join multiple files or commands
smart_join_cmd=perl $common_bin_dir/smart_join.pl
#concatenate / cut files or commands
smart_cut_cmd=perl $common_bin_dir/smart_cut.pl
add_function_cmd=perl $common_bin_dir/smart_cut.pl
bin_values_cmd=perl $common_bin_dir/bin_values.pl
#this can add a new column that's a function of other columns (add, divide, log, abs, etc.)
add_header_cmd=perl $common_bin_dir/add_header.pl
#transpose a file
transpose_cmd=perl $common_bin_dir/transpose.pl
#generate a nice pdf from the file
table_to_beamer_cmd=perl $common_bin_dir/table_to_beamer.pl
text_to_beamer_cmd=perl $common_bin_dir/text_to_beamer.pl
#pretty print columns (e.g. %.3g)
format_columns_cmd=perl $common_bin_dir/format_columns.pl
vcf_utils_cmd=perl $targeted_bin_dir/vcf_utils.pl
table_sum_stats_cmd=perl $common_bin_dir/table_sum_stats.pl

draw_qq_plot_cmd=Rscript $common_bin_dir/draw_qq_plot.R

#cmd_class prefix tells it to match on value of the key and then execute the postfixes
#postfix use_mod says run "use" when this command is run
#so just using "Rscript" in commands below will automatically load R-3.4
cmd_class rscript_cmd_class=Rscript use_mod R-3.4
cmd_class tabix_cmd_class=tabix use_mod Tabix
cmd_class bgzip_cmd_class=bgzip use_mod Tabix
cmd_class plink_cmd_class=plink use_mod PLINK2
#=======================================================================================================================